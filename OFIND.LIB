(FIND ALL HEIGHTS OF INSERTS - RECORD TO VC#'S PSRT-PEND)
OFIND

(MACHINE: MU6300V-L - OSP P500)
(PROGRAMMER: JUSTIN BROWN)
(REV: 0)
(DATE: 07/27/2024)

(PASS IN VARIABLES REQUIRED:)
( PX = 0 ALWAYS)
( PY = TOOL RADIUS - .1mm)
( PRS = ROT OF 1ST INSERT -- *MUST BE LOWEST NUMBER* )
( PINS = # OF INSERTS)
( PMAX = MAX # OF INSERTS)
( PSRT = START OF VC# TO READ)

(CHECK PASSED VARIABLES)
    (CHECK FOR EMPTY VARIABLES:)
        IF [PRS EQ EMPTY] NALM1
        IF [PINS EQ EMPTY] NALM1
        IF [PMAX EQ EMPTY] NALM1
    (VALIDATE VALUES:)
        IF [PINS LT 2] NALM2 (CANNOT COMPARE LESS THAN 2 INSERTS)
        IF [PINS GT PMAX] NALM3 (INSERT AMOUNT CANNOT EXCEED MAX)
()

(SET ADD'L VARIABLES:)
    CNTR = 1 (INITIALIZE COUNTER, TRACKS ACTIVE INSERT)
    ROT = [ 360 / PINS ] (CALCULATE ROTATION DEGREES TO NEXT INSERT)
    POS = PRS (CURRENT SPINDLE ROTATION POSITION)
    MROT = PRS + [ROT * [PINS - 1]] (CALCULATE MAX ROTATION)
    PNTR = PSRT (INITIALIZE VC POINTER TO STRT - DEFINED IN MAIN PGM)

(ALARM PRE-CHECKS)
    IF [MROT GT 360] NALM4 (HIGHEST ROTATION EXCEEDS 360 DEGREES)
()

(SAVE ALL Z HEIGHTS INTO VARIABLES, MAX 8 INSERTS)

(LOOP UNTIL COUNTER EXCEEDS INSERTS)
(BUILDS LOCAL VARS: LEN1 - LEN[PINS])
WHILE [ CNTR LE PINS ] DO 1
    CALL OTCH PX=PX PY=PY PRS=POS (GET LENGTH)
    VC[PNTR] = VTOHT[[VTLCN],10001] (EXTRACT LENGTH INTO COMMON VAR: VC1-VC[MAX])
    POS = POS + ROT (NEXT INSERT SPINDLE ROTATION)
    PNTR = [PNTR + 1] (INCREMENT VC# POINTER)
    CNTR = [CNTR + 1] (INCREMENT COUNTER)

END 1

GOTO NEND

(ALARMS)
    NALM1 (MISSING VARIABLE @ CALL - "PRS" OR "PINS" OR "PMAX")
        VUACM[1]='MISSING VARIABLE'
        VDOUT[993]=9001

    NALM2 (PINS LESS THAN 2 ALARM)
        VUACM[1]='PINS LESS THAN 2' (USE G120 [SINGLE INSERT SET] NOT NROT)
        VDOUT[993]=9001

    NALM3 (PINS VALUE TOO LARGE ALARM)
        VUACM[1]='PINS GT PMAX' ("PINS" GREATER THAN "PMAX")
        VDOUT[993]=9001
    
    NALM4 (initial rotation not the smallest)
        VUACM[1]='PRS NOT SMALLEST' (reduce initial tool rotation, or PINS > actual inserts)
        VDOUT[993]=9001



NEND
RTS
