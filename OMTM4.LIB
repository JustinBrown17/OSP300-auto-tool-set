(MASTER TOOLSET MULTI + OFFSET AUTO BREAK DETECT - G111)
OMTM4

(MACHINE: MU6300V-L - OSP P500)
(PROGRAMMER: JUSTIN BROWN)
(REV: 4)
(DATE: 07/29/2024)

(CALLING THIS SUB:)
    (G111 PMLT=1 -- FOR MULTISET)
    (G111 PBRK=1 -- FOR BREAK DETECTION)
    (G111 -- FOR SINGLE SET)
    (NOTE: USES VC#'S: VC[PSRT] - VC[PEND] )

(DECLARE VC#'S TO BE CLEARED + USED)
    PSRT = 1 (SET START VC#)
    PMAX = 16 (MAX NUMBER OF INSERTS)
    PEND = [PSRT + PMAX - 1] (CALCULATE STOP VC#)

(START PGM)
G4 F1.

(CHECK PMAX IS VALID -- MUST BE AT LEAST 4 TO PASS VARS BACK)
    IF [PMAX LT 4] NALM1

(CLEAR NEEDED VC#'S)
    CALL OCLER PSRT=PSRT PEND=PEND
(CALL TOOL DATA SUB)
    CALL OTDAT PSRT=PSRT PEND=PEND

(PASS CONDITIONS FROM "OTDAT")
    PX   = VC[PSRT]
    PY   = VC[PSRT + 1]
    PRS  = VC[PSRT + 2]
    PINS = VC[PSRT + 3]

    (CLEAR OUT VC#'S AGAIN)
    CALL OCLER PSRT=PSRT PEND=PEND


NSET
    (JUMP TO MULTI-SET IF: G111 PMLT=1)
        IF [ PBRK EQ 1 ] NSING (DEFAULT TO SINGLE-SET - IF PRBK / BREAK DETECT)
        IF [ PINS EQ EMPTY ] NSING (DEFAULT TO SINGLE SET - IF PINS NOT SET)
        IF [ PMLT EQ 1 ] NMULT
 
NSING (SINGLE SET / OFFSET TOOL BREAK DETECT)
        CALL OTCH PX=PX PY=PY PRS=PRS PBRK=PBRK
        GOTO NEND

NMULT (MULTI SET - FINDS HIGHEST AND SETS AS "HA")
    (FIND ALL INSERTS LENGTHS + CLEAR NEEDED VC#'S)
        CALL OFIND PX=PX PY=PY PRS=PRS PINS=PINS PMAX=PMAX PSRT=PSRT
    (SET CURRENT TOOL TO HIGHEST INSERT LENGTH)
        CALL OMAXL PSRT=PSRT PEND=PEND
    (CLEAR VC#'S USED)
        M1 (OP STOP - CHECK VARIABLES BEFORE CLEARING)
	CALL OCLER PSRT=PSRT PEND=PEND
   
    GOTO NEND

(ALARMS)
    NALM (WRONG TOOL ALARM, TOOL NOT FOUND IN OMTM4 TOOL LIBRARY)
    VUACM[1]='VERIFY TOOL #'
    VDOUT[993]=9001

NEND
G30 P32
RTS
